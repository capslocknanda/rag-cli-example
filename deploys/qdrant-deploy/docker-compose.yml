services:
  qdrant:
    # Changed from 1.2.1 to latest (or v1.12.0 for stability)
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334" # Added gRPC port for better performance
    volumes:
      - qdrant_storage:/qdrant/storage # Note: path is case-sensitive in some versions (/qdrant/storage)
      - ./backups:/backups:ro
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped

  restore:
    image: ubuntu:22.04
    container_name: qdrant_restore
    depends_on:
      - qdrant
    volumes:
      - qdrant_storage:/qdrant/storage # Ensure restore container can see the storage if needed
      - ./backups:/backups:ro
      - ./restore.sh:/restore.sh:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        apt-get update && apt-get install -y curl
        echo "Waiting for Qdrant..."
        # Using the standard /readyz health check
        until curl -s -f http://qdrant:6333/readyz; do 
          echo "Qdrant is not ready yet..."
          sleep 2
        done
        echo "Qdrant is UP! Starting restore..."
        if [ -f /backups/restore.sh ]; then
          bash /backups/restore.sh
        fi
    restart: "no"

volumes:
  qdrant_storage: